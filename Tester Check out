<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Punto Pago Checkout — Demo</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root{--bg:#f4f6f8;--card:#fff;--accent:#0a5cff;--muted:#6b7280}
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background:var(--bg);
            margin:0;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:24px;
            color:#111827;
        }
        .checkout{
            width:100%;
            max-width:460px;
            background:var(--card);
            border-radius:12px;
            box-shadow:0 6px 30px rgba(11,20,40,0.08);
            padding:20px;
        }
        h2{margin:0 0 12px;text-align:center;font-size:20px}
        .row{display:flex;gap:12px}
        label{display:block;font-size:13px;color:var(--muted);margin-top:14px}
        input,select,button{width:100%;padding:10px 12px;border:1px solid #e6e9ef;border-radius:8px;font-size:15px}
        input:focus,select:focus,button:focus{outline:2px solid rgba(10,92,255,0.12);outline-offset:2px}
        .controls{margin-top:14px}
        button.primary{
            background:var(--accent);color:#fff;border:none;cursor:pointer;border-radius:8px;
        }
        button.ghost{background:#fff;border:1px solid #e6e9ef}
        button:disabled{opacity:.6;cursor:default}
        .meta{font-size:13px;color:var(--muted);margin-top:10px;text-align:center}
        .result{margin-top:16px;padding:12px;border-radius:8px;font-size:15px}
        .success{background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0}
        .error{background:#fff1f2;color:#881337;border:1px solid #fecaca}
        .hidden{display:none}
        .spinner{
            display:inline-block;width:18px;height:18px;border:3px solid rgba(255,255,255,0.18);border-top-color:#fff;border-radius:50%;
            animation:spin 1s linear infinite;vertical-align:middle;margin-right:8px
        }
        @keyframes spin{to{transform:rotate(360deg)}}
        .flex{display:flex;gap:8px;align-items:center}
        .copy-btn{padding:8px 10px;border-radius:8px;background:#f3f4f6;border:1px solid #e6e9ef;cursor:pointer}
        .note{font-size:13px;color:var(--muted);margin-top:8px}
    </style>
</head>
<body>
    <main class="checkout" aria-labelledby="title">
        <h2 id="title">Punto Pago Checkout</h2>

        <!-- Paso 1: Identificacion de cuenta -->
        <label for="account">Cuenta / Referencia</label>
        <input id="account" type="text" inputmode="text" autocomplete="off" placeholder="Ej: contrato, teléfono, email" aria-describedby="acct-help" />

        <div id="acct-help" class="note">Guarda la cuenta para búsquedas rápidas.</div>

        <!-- Paso 2: Medio de pago -->
        <label for="payment">Medio de pago</label>
        <select id="payment" aria-label="Medio de pago">
            <option value="">Selecciona un medio</option>
            <option value="visa">Tarjeta Visa / Mastercard</option>
            <option value="paypal">PayPal</option>
            <option value="applepay">Apple Pay</option>
            <option value="googlepay">Google Pay</option>
            <option value="yappy">Yappy (QR)</option>
        </select>

        <!-- Paso 3: Boton de pago -->
        <div class="controls row" style="margin-top:16px">
            <button id="payBtn" class="primary" disabled aria-disabled="true">Pagar</button>
            <button id="clearBtn" class="ghost" type="button">Limpiar</button>
        </div>

        <div id="result" class="result hidden" role="status" aria-live="polite"></div>

        <div class="meta">Versión demo — simulación local de pago</div>
    </main>

    <script>
        // Elementos
        const accountInput = document.getElementById('account');
        const paymentSelect = document.getElementById('payment');
        const payBtn = document.getElementById('payBtn');
        const clearBtn = document.getElementById('clearBtn');
        const result = document.getElementById('result');

        // Guardar última cuenta en localStorage para conveniencia
        const LS_KEY = 'punto_pago_last_account';
        try {
            const saved = localStorage.getItem(LS_KEY);
            if (saved) accountInput.value = saved;
        } catch (e) { /* ignore */ }

        function setResult(type, html) {
            result.className = 'result';
            result.classList.add(type === 'success' ? 'success' : 'error');
            result.innerHTML = html;
            result.classList.remove('hidden');
        }

        function clearResult() {
            result.className = 'result hidden';
            result.innerHTML = '';
        }

        function validateForm() {
            const ok = accountInput.value.trim() !== '' && paymentSelect.value !== '';
            payBtn.disabled = !ok;
            payBtn.setAttribute('aria-disabled', String(!ok));
        }

        accountInput.addEventListener('input', () => {
            validateForm();
            try { localStorage.setItem(LS_KEY, accountInput.value.trim()); } catch(e) {}
        });
        paymentSelect.addEventListener('change', validateForm);

        clearBtn.addEventListener('click', () => {
            accountInput.value = '';
            paymentSelect.value = '';
            validateForm();
            clearResult();
            try { localStorage.removeItem(LS_KEY); } catch(e) {}
            accountInput.focus();
        });

        // Simula una llamada a API para procesar pago (exito o fallo aleatorio)
        function simulatePayment({ account, method }) {
            return new Promise((resolve) => {
                // Duración variable para mayor realismo
                const delay = 1000 + Math.random() * 2000;
                setTimeout(() => {
                    // 90% de éxito en demo
                    const success = Math.random() < 0.9;
                    const reference = Math.floor(100000000 + Math.random() * 899999999).toString();
                    resolve({ success, reference, message: success ? 'Pago recibido correctamente' : 'Error procesando el pago' });
                }, delay);
            });
        }

        async function handlePayClick() {
            clearResult();
            const account = accountInput.value.trim();
            const method = paymentSelect.value;

            if (!account || !method) return;

            // Disabled while processing
            payBtn.disabled = true;
            payBtn.setAttribute('aria-disabled', 'true');
            accountInput.disabled = true;
            paymentSelect.disabled = true;
            clearBtn.disabled = true;

            // Mostrar estado
            payBtn.innerHTML = '<span class="spinner" aria-hidden="true"></span>Procesando...';
            setResult('success', '<div class="flex"><strong>Procesando pago...</strong></div>');

            try {
                const res = await simulatePayment({ account, method });

                if (res.success) {
                    // Mostrar resultados detallados con botón copiar y flujo según método
                    let extra = '';
                    if (method === 'yappy') {
                        // En una integración real aquí se mostraría un QR
                        extra = '<div style="margin-top:8px;padding:10px;background:#fff;border-radius:8px;border:1px dashed #e6e9ef;text-align:center">Escanea este código QR en Yappy (demo)</div>';
                    } else if (method === 'applepay' || method === 'googlepay') {
                        extra = '<div class="note">Método digital detectado. Se iniciará el flujo de pago en la app correspondiente (demo).</div>';
                    }

                    setResult('success', `
                        <div>
                            <div style="font-weight:600">${res.message}</div>
                            <div class="note" style="margin-top:8px">Cuenta: <strong>${escapeHtml(account)}</strong></div>
                            <div class="note" style="margin-top:6px">Referencia: <strong id="refVal">${res.reference}</strong></div>
                            <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
                                <button id="copyRef" class="copy-btn" type="button">Copiar referencia</button>
                            </div>
                            ${extra}
                        </div>
                    `);

                    // Añadir listener para copiar referencia
                    document.getElementById('copyRef').addEventListener('click', async () => {
                        const ref = res.reference;
                        try {
                            await navigator.clipboard.writeText(ref);
                            // reemplazar temporalmente el texto del botón para feedback
                            const btn = document.getElementById('copyRef');
                            const old = btn.textContent;
                            btn.textContent = 'Copiado';
                            setTimeout(() => btn.textContent = old, 1500);
                        } catch (e) {
                            alert('No se pudo copiar la referencia. Selecciona y copia manualmente.');
                        }
                    });

                } else {
                    setResult('error', `<strong>${res.message}</strong><div class="note" style="margin-top:8px">Intenta nuevamente o contacta soporte.</div>`);
                }
            } catch (err) {
                setResult('error', `<strong>Error inesperado</strong><div class="note" style="margin-top:8px">${escapeHtml(String(err))}</div>`);
            } finally {
                // Re-enable
                payBtn.disabled = false;
                payBtn.setAttribute('aria-disabled', 'false');
                accountInput.disabled = false;
                paymentSelect.disabled = false;
                clearBtn.disabled = false;
                payBtn.innerHTML = 'Pagar';
                validateForm();
            }
        }

        payBtn.addEventListener('click', handlePayClick);

        // Escapar HTML para evitar inyección en demo
        function escapeHtml(s) {
            return s.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        }

        // Inicial validation
        validateForm();
    </script>
</body>
</html>